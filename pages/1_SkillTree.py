import streamlit as st
import json
import math

st.set_page_config(layout="wide")

# =================================================================
# 1. è£œæ­£ãƒ‡ãƒ¼ã‚¿å®šç¾© (WIKIå€¤ã¨è£œæ­£ç‡)
# =================================================================

# --- WIKIã‹ã‚‰æä¾›ã•ã‚ŒãŸLv100ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹è£œæ­£æ¸ˆã¿åŸºç¤å€¤ ---
# ã“ã®å€¤ã¯ã€ã‚¯ãƒ©ã‚¹è£œæ­£ã¯é©ç”¨æ¸ˆã¿ã ãŒã€ç¨®æ—è£œæ­£ã¯æœªé©ç”¨ã¨ã„ã†å‰æã§åˆ©ç”¨ã—ã¾ã™ã€‚
WIKI_MAIN_STATS = {
    "Hu": {"HP": 764, "PP": 120, "æ‰“æ’ƒåŠ›": 580, "å°„æ’ƒåŠ›": 540, "æ³•æ’ƒåŠ›": 451, "æŠ€é‡": 415, "æ‰“æ’ƒé˜²å¾¡": 580, "å°„æ’ƒé˜²å¾¡": 451, "æ³•æ’ƒé˜²å¾¡": 451},
    "Fi": {"HP": 655, "PP": 120, "æ‰“æ’ƒåŠ›": 580, "å°„æ’ƒåŠ›": 450, "æ³•æ’ƒåŠ›": 540, "æŠ€é‡": 415, "æ‰“æ’ƒé˜²å¾¡": 580, "å°„æ’ƒé˜²å¾¡": 450, "æ³•æ’ƒé˜²å¾¡": 450},
    "Ra": {"HP": 645, "PP": 120, "æ‰“æ’ƒåŠ›": 540, "å°„æ’ƒåŠ›": 580, "æ³•æ’ƒåŠ›": 450, "æŠ€é‡": 415, "æ‰“æ’ƒé˜²å¾¡": 450, "å°„æ’ƒé˜²å¾¡": 580, "æ³•æ’ƒé˜²å¾¡": 450},
    "Gu": {"HP": 650, "PP": 120, "æ‰“æ’ƒåŠ›": 540, "å°„æ’ƒåŠ›": 580, "æ³•æ’ƒåŠ›": 450, "æŠ€é‡": 415, "æ‰“æ’ƒé˜²å¾¡": 450, "å°„æ’ƒé˜²å¾¡": 580, "æ³•æ’ƒé˜²å¾¡": 450},
    "Fo": {"HP": 536, "PP": 120, "æ‰“æ’ƒåŠ›": 450, "å°„æ’ƒåŠ›": 540, "æ³•æ’ƒåŠ›": 580, "æŠ€é‡": 415, "æ‰“æ’ƒé˜²å¾¡": 450, "å°„æ’ƒé˜²å¾¡": 450, "æ³•æ’ƒé˜²å¾¡": 580},
    "Te": {"HP": 536, "PP": 120, "æ‰“æ’ƒåŠ›": 540, "å°„æ’ƒåŠ›": 450, "æ³•æ’ƒåŠ›": 580, "æŠ€é‡": 415, "æ‰“æ’ƒé˜²å¾¡": 580, "å°„æ’ƒé˜²å¾¡": 450, "æ³•æ’ƒé˜²å¾¡": 450},
    "Br": {"HP": 655, "PP": 120, "æ‰“æ’ƒåŠ›": 545, "å°„æ’ƒåŠ›": 545, "æ³•æ’ƒåŠ›": 486, "æŠ€é‡": 420, "æ‰“æ’ƒé˜²å¾¡": 488, "å°„æ’ƒé˜²å¾¡": 488, "æ³•æ’ƒé˜²å¾¡": 488},
    "Bo": {"HP": 655, "PP": 120, "æ‰“æ’ƒåŠ›": 545, "å°„æ’ƒåŠ›": 486, "æ³•æ’ƒåŠ›": 545, "æŠ€é‡": 420, "æ‰“æ’ƒé˜²å¾¡": 488, "å°„æ’ƒé˜²å¾¡": 488, "æ³•æ’ƒé˜²å¾¡": 488},
    "Su": {"HP": 645, "PP": 120, "æ‰“æ’ƒåŠ›": 545, "å°„æ’ƒåŠ›": 545, "æ³•æ’ƒåŠ›": 545, "æŠ€é‡": 420, "æ‰“æ’ƒé˜²å¾¡": 488, "å°„æ’ƒé˜²å¾¡": 488, "æ³•æ’ƒé˜²å¾¡": 488},
    "Hr": {"HP": 804, "PP": 120, "æ‰“æ’ƒåŠ›": 698, "å°„æ’ƒåŠ›": 698, "æ³•æ’ƒåŠ›": 698, "æŠ€é‡": 549, "æ‰“æ’ƒé˜²å¾¡": 697, "å°„æ’ƒé˜²å¾¡": 697, "æ³•æ’ƒé˜²å¾¡": 697},
    "Ph": {"HP": 780, "PP": 120, "æ‰“æ’ƒåŠ›": 711, "å°„æ’ƒåŠ›": 711, "æ³•æ’ƒåŠ›": 711, "æŠ€é‡": 564, "æ‰“æ’ƒé˜²å¾¡": 659, "å°„æ’ƒé˜²å¾¡": 659, "æ³•æ’ƒé˜²å¾¡": 659},
    "Et": {"HP": 819, "PP": 120, "æ‰“æ’ƒåŠ›": 677, "å°„æ’ƒåŠ›": 677, "æ³•æ’ƒåŠ›": 677, "æŠ€é‡": 543, "æ‰“æ’ƒé˜²å¾¡": 730, "å°„æ’ƒé˜²å¾¡": 730, "æ³•æ’ƒé˜²å¾¡": 730},
    "Lu": {"HP": 795, "PP": 120, "æ‰“æ’ƒåŠ›": 684, "å°„æ’ƒåŠ›": 684, "æ³•æ’ƒåŠ›": 684, "æŠ€é‡": 576, "æ‰“æ’ƒé˜²å¾¡": 710, "å°„æ’ƒé˜²å¾¡": 710, "æ³•æ’ƒé˜²å¾¡": 710},
}

# --- ç¨®æ—è£œæ­£ãƒ‡ãƒ¼ã‚¿ (ä¹—ç®—è£œæ­£: 1.05 = +5%, 0.95 = -5%) ---
RACE_CORRECTIONS = {
    "ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ç”·": {"HP": 1.05, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.04, "å°„æ’ƒåŠ›": 1.03, "æ³•æ’ƒåŠ›": 1.00, "æŠ€é‡": 1.05, "æ‰“æ’ƒé˜²å¾¡": 1.05, "å°„æ’ƒé˜²å¾¡": 1.00, "æ³•æ’ƒé˜²å¾¡": 1.00},
    "ãƒ’ãƒ¥ãƒ¼ãƒãƒ³å¥³": {"HP": 1.04, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.00, "å°„æ’ƒåŠ›": 1.03, "æ³•æ’ƒåŠ›": 1.04, "æŠ€é‡": 1.06, "æ‰“æ’ƒé˜²å¾¡": 1.00, "å°„æ’ƒé˜²å¾¡": 1.00, "æ³•æ’ƒé˜²å¾¡": 1.05},
    "ãƒ‹ãƒ¥ãƒ¼ãƒãƒ³ç”·": {"HP": 0.95, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.00, "å°„æ’ƒåŠ›": 1.02, "æ³•æ’ƒåŠ›": 1.08, "æŠ€é‡": 1.04, "æ‰“æ’ƒé˜²å¾¡": 1.00, "å°„æ’ƒé˜²å¾¡": 1.05, "æ³•æ’ƒé˜²å¾¡": 1.00},
    "ãƒ‹ãƒ¥ãƒ¼ãƒãƒ³å¥³": {"HP": 0.94, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.00, "å°„æ’ƒåŠ›": 1.02, "æ³•æ’ƒåŠ›": 1.10, "æŠ€é‡": 1.04, "æ‰“æ’ƒé˜²å¾¡": 1.00, "å°„æ’ƒé˜²å¾¡": 1.00, "æ³•æ’ƒé˜²å¾¡": 1.05},
    "ã‚­ãƒ£ã‚¹ãƒˆç”·":   {"HP": 1.07, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.05, "å°„æ’ƒåŠ›": 1.04, "æ³•æ’ƒåŠ›": 0.96, "æŠ€é‡": 1.07, "æ‰“æ’ƒé˜²å¾¡": 1.05, "å°„æ’ƒé˜²å¾¡": 1.00, "æ³•æ’ƒé˜²å¾¡": 0.95},
    "ã‚­ãƒ£ã‚¹ãƒˆå¥³":   {"HP": 1.06, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.04, "å°„æ’ƒåŠ›": 1.05, "æ³•æ’ƒåŠ›": 0.96, "æŠ€é‡": 1.07, "æ‰“æ’ƒé˜²å¾¡": 1.00, "å°„æ’ƒé˜²å¾¡": 1.05, "æ³•æ’ƒé˜²å¾¡": 0.95},
    "ãƒ‡ãƒ¥ãƒ¼ãƒãƒ³ç”·": {"HP": 0.96, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.07, "å°„æ’ƒåŠ›": 1.04, "æ³•æ’ƒåŠ›": 1.05, "æŠ€é‡": 1.05, "æ‰“æ’ƒé˜²å¾¡": 1.00, "å°„æ’ƒé˜²å¾¡": 1.00, "æ³•æ’ƒé˜²å¾¡": 1.00},
    "ãƒ‡ãƒ¥ãƒ¼ãƒãƒ³å¥³": {"HP": 0.95, "PP": 1.00, "æ‰“æ’ƒåŠ›": 1.06, "å°„æ’ƒåŠ›": 1.05, "æ³•æ’ƒåŠ›": 1.05, "æŠ€é‡": 1.06, "æ‰“æ’ƒé˜²å¾¡": 1.00, "å°„æ’ƒé˜²å¾¡": 1.00, "æ³•æ’ƒé˜²å¾¡": 1.00},
}

# --- ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆã®å›ºå®šå€¤ (å…¨ã‚¯ãƒ©ã‚¹Lv75é”æˆæ™‚ã®ãƒœãƒ¼ãƒŠã‚¹) ---
CLASS_BOOST_BONUS = {
    "HP": 60, "PP": 10, "æ‰“æ’ƒåŠ›": 120, "å°„æ’ƒåŠ›": 120, "æ³•æ’ƒåŠ›": 120, "æŠ€é‡": 60, "æ‰“æ’ƒé˜²å¾¡": 90, "å°„æ’ƒé˜²å¾¡": 90, "æ³•æ’ƒé˜²å¾¡": 90
}
# -------------------------------------------------------------------

# ãƒã‚°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šç¾©
MAG_STATS_FIELDS = ["æ‰“æ’ƒåŠ›", "å°„æ’ƒåŠ›", "æ³•æ’ƒåŠ›", "æŠ€é‡", "æ‰“æ’ƒé˜²å¾¡", "å°„æ’ƒé˜²å¾¡", "æ³•æ’ƒé˜²å¾¡"]
STATS_FIELDS = ["HP", "PP", "æ‰“æ’ƒåŠ›", "å°„æ’ƒåŠ›", "æ³•æ’ƒåŠ›", "æŠ€é‡", "æ‰“æ’ƒé˜²å¾¡", "å°„æ’ƒé˜²å¾¡", "æ³•æ’ƒé˜²å¾¡"]
ALL_CLASSES = list(WIKI_MAIN_STATS.keys())
UNAVAILABLE_SUBCLASSES = ["Hr"]
SUCCESSOR_MAIN_CLASSES = ["Hr", "Ph", "Et", "Lu"]

# --- å››æ¨äº”å…¥é–¢æ•° (X.5ã§ç¹°ã‚Šä¸Šã’) ---
def custom_round(num):
    """ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã®ç¨®æ—è£œæ­£é©ç”¨æ™‚ã«ä½¿ç”¨ã™ã‚‹ã€æ¨™æº–çš„ãªå››æ¨äº”å…¥ï¼ˆX.5ã§ç¹°ã‚Šä¸Šã’ï¼‰"""
    return int(num + 0.5)

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ– ---
# å‰å›ã®è¨­å®šå€¤ã‚’ä¿æŒ
if 'main_class_select' not in st.session_state: st.session_state['main_class_select'] = "Gu" 
if 'sub_class_select' not in st.session_state: st.session_state['sub_class_select'] = "Lu" 
if 'race_select' not in st.session_state: st.session_state['race_select'] = "ã‚­ãƒ£ã‚¹ãƒˆå¥³" 
if 'mag_stats' not in st.session_state: 
    st.session_state['mag_stats'] = {field: 200 if field == "å°„æ’ƒåŠ›" else 0 for field in MAG_STATS_FIELDS}
if 'class_boost_enabled' not in st.session_state: st.session_state['class_boost_enabled'] = True 

# =================================================================
# 2. è¨ˆç®—é–¢æ•° (WIKIå€¤èµ·ç‚¹ + å…¨ã‚¹ãƒ†ãƒƒãƒ—åˆ‡ã‚Šæ¨ã¦é©ç”¨)
# =================================================================

def get_calculated_stats():
    """
    WIKIã®ã‚¯ãƒ©ã‚¹è£œæ­£æ¸ˆã¿åŸºç¤å€¤ã«ã€ç¨®æ—è£œæ­£ã€ãƒã‚°ã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹è²¢çŒ®åº¦ã€ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆã‚’åˆç®—ã—ãŸåŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
    
    ãƒ­ã‚¸ãƒƒã‚¯ã®é †åº:
    1. ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹æœ€çµ‚å€¤ = ROUND(WIKI_MAIN_STATS[ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹] * ç¨®æ—è£œæ­£)
    2. ã‚µãƒ–ã‚¯ãƒ©ã‚¹è²¢çŒ®åº¦ = Floor(Floor(WIKI_MAIN_STATS[ã‚µãƒ–ã‚¯ãƒ©ã‚¹] * ç¨®æ—è£œæ­£) * 0.2)
    3. åˆè¨ˆ = ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹æœ€çµ‚å€¤ + ãƒã‚° + ã‚µãƒ–ã‚¯ãƒ©ã‚¹è²¢çŒ®åº¦ + ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆ
    """
    
    race = st.session_state['race_select']
    main_class = st.session_state['main_class_select']
    sub_class_select = st.session_state['sub_class_select']
    
    race_cor = RACE_CORRECTIONS.get(race, {})
    mag_stats = st.session_state['mag_stats']
    
    # ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆãƒœãƒ¼ãƒŠã‚¹
    CB_BONUS = CLASS_BOOST_BONUS if st.session_state['class_boost_enabled'] else {k: 0 for k in CLASS_BOOST_BONUS.keys()}
        
    calculated_stats = {}

    for stat_name in STATS_FIELDS:
        # WIKIã‹ã‚‰ã‚¯ãƒ©ã‚¹è£œæ­£æ¸ˆã¿åŸºç¤å€¤ã‚’å–å¾—
        wiki_main_base_val = WIKI_MAIN_STATS.get(main_class, {}).get(stat_name, 0)
        
        # --- 1. ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®— ---
        
        # 1-1. ç¨®æ—è£œæ­£é©ç”¨ (å››æ¨äº”å…¥)
        # HPã¨PPã¯ç‰¹åˆ¥ãªè¨ˆç®—ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ãŸã‚ã€HP/PPã®ã¿åˆ‡ã‚Šæ¨ã¦ã‚’ç¶­æŒã—ã€ä»–ã®ATK/DEF/æŠ€é‡ã¯å››æ¨äº”å…¥ã‚’é©ç”¨
        race_multiplier = race_cor.get(stat_name, 1.0)
        
        if stat_name in ['HP', 'PP']:
             # HPã¨PPã¯å¸¸ã«åˆ‡ã‚Šæ¨ã¦ã‚’é©ç”¨
            main_final_value = int(wiki_main_base_val * race_multiplier)
        else:
            # ATK/DEF/æŠ€é‡ã¯å››æ¨äº”å…¥ã‚’é©ç”¨ (æ³•é˜²ã®1ãƒã‚¤ãƒ³ãƒˆã‚ºãƒ¬ã‚’è§£æ¶ˆ)
            main_final_value = custom_round(wiki_main_base_val * race_multiplier)
        
        total_value = main_final_value

        # --- 2. ã‚µãƒ–ã‚¯ãƒ©ã‚¹è²¢çŒ®åº¦ & ãƒã‚° (ATK/DEF/ACC/æŠ€é‡ã®ã¿) ---
        
        if stat_name not in ['HP', 'PP']:
            
            # ãƒã‚°ãƒœãƒ¼ãƒŠã‚¹åŠ ç®—
            mag_bonus = mag_stats.get(stat_name, 0)
            total_value += mag_bonus
            
            sub_contribution = 0
            
            # ã‚µãƒ–ã‚¯ãƒ©ã‚¹ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€ã‹ã¤ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ãŒå¾Œç¶™ã‚¯ãƒ©ã‚¹ã§ã¯ãªã„å ´åˆ
            if sub_class_select != 'None' and main_class not in SUCCESSOR_MAIN_CLASSES:
                
                # ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã®WIKIå€¤ã‚’å–å¾—
                wiki_sub_base_val = WIKI_MAIN_STATS.get(sub_class_select, {}).get(stat_name, 0)

                # 2-1. ç¨®æ—è£œæ­£é©ç”¨ (åˆ‡ã‚Šæ¨ã¦) - WIKIå€¤ã‹ã‚‰è¨ˆç®—ã‚’å§‹ã‚ã‚‹
                sub_after_race = int(wiki_sub_base_val * race_multiplier)
                
                # 2-2. ã‚µãƒ–ã‚¯ãƒ©ã‚¹è²¢çŒ®åº¦ 20% é©ç”¨ (åˆ‡ã‚Šæ¨ã¦)
                sub_contribution = int(sub_after_race * 0.2)
                
                total_value += sub_contribution

        # --- 3. ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆåŠ ç®— ---
        
        # ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆå¢—åŠ åˆ† (å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…±é€š)
        total_value += CB_BONUS.get(stat_name, 0)
                
        calculated_stats[stat_name] = total_value
        
    return calculated_stats

# =================================================================
# Streamlit UI
# =================================================================

st.title("ğŸ“š 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—æ©Ÿ (WIKIåŸºç¤å€¤æ¡ç”¨ç‰ˆ)")
st.caption("â€» æ³•é˜²ã®ã‚ºãƒ¬è§£æ¶ˆã®ãŸã‚ã€ATK/DEF/æŠ€é‡ã®ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹è£œæ­£ã«å››æ¨äº”å…¥ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚HP/PPã¯åˆ‡ã‚Šæ¨ã¦ã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚")

# =================================================================
# 1. ã‚¯ãƒ©ã‚¹æ§‹æˆ (ã‚¯ãƒ©ã‚¹ / ã‚µãƒ–ã‚¯ãƒ©ã‚¹)
# =================================================================

st.subheader("ã‚¯ãƒ©ã‚¹æ§‹æˆ")
col_main_class, col_sub_class = st.columns(2)

with col_main_class:
    main_class = st.selectbox(
        "ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹",
        options=ALL_CLASSES,
        key="main_class_select",
    )

with col_sub_class:
    # --- ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
    if main_class in SUCCESSOR_MAIN_CLASSES:
        # ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ãŒå¾Œç¶™ã‚¯ãƒ©ã‚¹ (Hr, Ph, Et, Lu) ã®å ´åˆã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã¯ "None" å›ºå®š
        st.selectbox(
            "ã‚µãƒ–ã‚¯ãƒ©ã‚¹",
            options=["None"],
            index=0,
            key="sub_class_select",
            disabled=True,
        )
        if st.session_state.get('sub_class_select') != "None":
            st.session_state['sub_class_select'] = "None" 

        st.info(f"{main_class}ã¯å¾Œç¶™ã‚¯ãƒ©ã‚¹ã®ãŸã‚ã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã¯Noneå›ºå®šã§ã™ã€‚", icon="â„¹ï¸")
    else:
        # ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ãŒæ—§ã‚¯ãƒ©ã‚¹ã®å ´åˆ
        sub_class_options_filtered = ["None"] + [
            c for c in ALL_CLASSES 
            if c != main_class and c not in UNAVAILABLE_SUBCLASSES 
        ]

        st.selectbox(
            "ã‚µãƒ–ã‚¯ãƒ©ã‚¹",
            options=sub_class_options_filtered,
            key="sub_class_select",
        )
        if st.session_state.get('sub_class_select') == "Hr":
            st.warning("Hrã¯ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã«è¨­å®šã§ãã¾ã›ã‚“ã€‚Noneã«æˆ»ã—ã¾ã™ã€‚")
            st.session_state['sub_class_select'] = "None"
            st.rerun()


st.markdown("---")

# =================================================================
# 2. ç¨®æ—è¨­å®š
# =================================================================

st.subheader("ç¨®æ—è¨­å®š")

RACE_OPTIONS = list(RACE_CORRECTIONS.keys())
st.selectbox(
    "ç¨®æ—",
    options=RACE_OPTIONS,
    key="race_select",
)

st.markdown("---")

# =================================================================
# 3. ãƒã‚°è¨­å®šã¨ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆ
# =================================================================

st.subheader("ãƒã‚°/ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆè¨­å®š")

# --- ãƒã‚°ã®å…¥åŠ› ---
st.markdown("##### ãƒã‚°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹")
# ãƒã‚°ã®åˆè¨ˆå€¤ã‚’æœ€åˆã«è¡¨ç¤º
current_total_mag = sum(st.session_state['mag_stats'].values())
MAG_MAX_TOTAL = 200
st.markdown(f"**åˆè¨ˆå€¤:** **`{current_total_mag} / {MAG_MAX_TOTAL}`**")

if current_total_mag > MAG_MAX_TOTAL:
    st.error(f"ãƒã‚°ã®åˆè¨ˆå€¤ãŒä¸Šé™ã® {MAG_MAX_TOTAL} ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼")
elif current_total_mag == MAG_MAX_TOTAL:
    st.success("ãƒã‚°ã®åˆè¨ˆå€¤ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚", icon="âœ…")

# ãƒã‚°ã®æ•°å€¤å…¥åŠ› (3åˆ—ã§é…ç½®)
mag_cols = st.columns(3) 

mag_fields = [
    ["æ‰“æ’ƒåŠ›", "å°„æ’ƒåŠ›", "æ³•æ’ƒåŠ›"],
    ["æ‰“æ’ƒé˜²å¾¡", "å°„æ’ƒé˜²å¾¡", "æ³•æ’ƒé˜²å¾¡"],
    ["æŠ€é‡"]
]

def update_mag_stats(field):
    st.session_state['mag_stats'][field] = st.session_state[f"mag_input_{field}"]

for col_idx, fields in enumerate(mag_fields):
    with mag_cols[col_idx]:
        for field in fields:
            st.number_input(
                field,
                min_value=0,
                max_value=MAG_MAX_TOTAL, 
                key=f"mag_input_{field}",
                value=st.session_state['mag_stats'].get(field, 0),
                step=1,
                label_visibility="visible",
                on_change=update_mag_stats,
                args=(field,)
            )

# --- ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆè¨­å®š ---
st.markdown("##### ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆ")
st.checkbox(
    "ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆå…¨ã‚¯ãƒ©ã‚¹Lv75é”æˆï¼‰",
    key="class_boost_enabled",
    value=st.session_state['class_boost_enabled'],
    help="ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€HP+60, PP+10, æ”»æ’ƒåŠ›+120, æŠ€é‡+60, é˜²å¾¡åŠ›+90ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚"
)

st.markdown("---")

# =================================================================
# 4. åˆè¨ˆåŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º (è¨ˆç®—çµæœè¡¨ç¤º)
# =================================================================

# è£œæ­£è¾¼ã¿ã®åˆè¨ˆå€¤ã‚’è¨ˆç®—
total_stats = get_calculated_stats()

st.subheader("åˆè¨ˆåŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (æœ€çµ‚ç†è«–å€¤)")

st.markdown(f"##### (WIKIã‚¯ãƒ©ã‚¹å€¤ + ç¨®æ—è£œæ­£ + ãƒã‚° + ã‚µãƒ–è²¢çŒ®åº¦ + ã‚¯ãƒ©ã‚¹ãƒ–ãƒ¼ã‚¹ãƒˆ)")
st.caption(f"â€» ATK/DEF/æŠ€é‡ã¯ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹è£œæ­£æ™‚ã®ã¿**å››æ¨äº”å…¥**ã€ãã®ä»–ã¯**åˆ‡ã‚Šæ¨ã¦**ã‚’é©ç”¨ã—ã¦ã„ã¾ã™ã€‚")

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ•´é “
stat_pairs = [
    ("æ‰“æ’ƒåŠ›", "æ‰“æ’ƒé˜²å¾¡"),
    ("å°„æ’ƒåŠ›", "å°„æ’ƒé˜²å¾¡"),
    ("æ³•æ’ƒåŠ›", "æ³•æ’ƒé˜²å¾¡"),
    ("æŠ€é‡", None),
    ("HP", "PP")
]

for stat1_name, stat2_name in stat_pairs:
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric(label=f"{stat1_name} (Total)", value=f"{total_stats[stat1_name]}")
    
    if stat2_name:
        with col2:
            st.metric(label=f"{stat2_name} (Total)", value=f"{total_stats[stat2_name]}")

st.markdown("---")
